{% extends "layout.html" %}

{% block content %}
<div class="chat-container">
    <div class="select-user">
        {% for user in users %}
        {% if user.user_id not in selected_users %}
        <div class="user" data-user-id="{{ user.user_id }}">
            {% if user.photo_base64 %}
            <img src="data:image/jpeg;base64,{{ user.photo_base64 }}" class="mainpage-pic">
            {% else %}
            <img src="/static/default_profile.jpg" class="mainpage-pic">
            {% endif %}
            <br />
            {{ user.name }}
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
    <div class="last-message">
        {% for message in last_messages|reverse %}
        <div class="last-message-box">
            <div class="message" data-user-id="{{ message.sender_id }}">
                <strong class="chat-size">{{ message.sender_name }}</strong>: {{ message.content }}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="chat-container-user">
        <div class="message-container" id="messageContainer">
            {% for message in messages %}
            <div class="message">
                <strong class="chat-size">{{ message.sender_name }}</strong>: {{ message.content }}
            </div>
            {% endfor %}
        </div>

        <form class="message-form" id="messageForm">
            <div class="textarea-container">
                <textarea class="message-input" name="content" placeholder="Napisz wiadomość"></textarea>
                <input type="submit" class="submit-button" value="Wyślij">
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var socket = io.connect('http://' + document.domain + ':' + location.port);

        function scrollToBottom() {
            var messageContainer = document.getElementById("messageContainer");
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
        scrollToBottom();

        var currentUserName = "{{ current_user.name }}";

        window.addNewMessage = function (senderName, content) {
            var messageContainer = document.getElementById("messageContainer");
            var newMessage = document.createElement("div");
            newMessage.className = "message";
            newMessage.innerHTML = '<strong class="chat-size">' + senderName + '</strong>: ' + content;
            messageContainer.appendChild(newMessage);

            scrollToBottom();
        };

        function handleUserSelection(userId) {
            window.location.href = '/chat/' + userId;
        }

        $('.select-user .user').click(function () {
            var selectedUserId = $(this).data('user-id');
            handleUserSelection(selectedUserId);
        });

        // Handle click event for last-messages
        $('.last-message .message').click(function () {
            var selectedUserId = $(this).data('user-id'); // Assuming you have user_id associated with last-messages
            handleUserSelection(selectedUserId);
        });

        $('#messageForm').submit(function (e) {
            e.preventDefault();
            var content = $('.message-input').val();

            if (content.trim() !== '') {
                $.ajax({
                    type: 'POST',
                    url: window.location.href,
                    data: { content: content },
                    success: function () {
                        $('.message-input').val('');
                    }
                });
            }
        });

        $('.message-input').keydown(function (e) {
            if (e.which === 13) {
                e.preventDefault();
                $('#messageForm').submit();
            }
        });

        socket.on('message', function (data) {
            addNewMessage(data.sender_name, data.content);
        });
    });
</script>
{% endblock %}
